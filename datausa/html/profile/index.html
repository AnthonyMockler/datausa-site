{% extends "templates/nav.html" %}

{% block title %}{{ profile.splash.title }}{% endblock %}

{% block body %}

<script>var builds = [];</script>

<div id="title-bar">
  <span><a href="/"><img src="/static/img/home/logo_b.png" alt="DataUSA" /></a> | {{ profile.splash.title }}
  <a href="#" class="expand-title-stats"><i class="fa fa-sliders"></i></a></span>
</div>

<div class="bound">
<div id="show-bg">
  <a href="#">
    <i class="fa fa-bolt"></i>
  </a>
</div>

<article id="splash">

  {% set sections = profile.sections() %}
  {% set image = profile.image() %}

  <div id="splash-image"{% if image %} style="background-image: url('{{ image.url }}');"{% endif %}></div>

  <div class="content">

    <div class="splash-breadcrumb">
      {% set parents = profile.parents() %}
      {% if parents|length %}
        <sub>
          {% for p in parents %}
            <a href="{{ url_for('profile.profile', attr_type=profile.attr_type, attr_id=p['id']) }}">{{ p["name"] }}</a>
          {% endfor %}
        </sub>
      {% endif %}
    </div>

    <div class="splash-titles">
      {% if profile.splash.group %}
      <div class="splash-title-group">{{ profile.splash.group }}</div>
      {% endif %}

      <h1>{{ profile.splash.title }}</h1>
    </div>

    <div class="splash-desc">
      {% for desc in profile.splash.description %}
      <p class="desc">{{ desc|safe }}</p>
      {% endfor %}
    </div>

    <div class="splash-context">

      <div class="context-l">
        {% if profile.splash.viz %}
        <div class="viz thumbprint"></div>
        <script>builds.push({{ profile.splash.viz.serialize()|safe }});</script>
        {% endif %}
      </div>

      <div class="context-r">
        <div id="splash-stats">
          {% for stat in profile.splash.stats %}
          <div class="stat">
            <div class="stat-text">{{ stat.title|safe }}</div>
            <div class="stat-group">
              <div class="stat-value">{{ stat.value|safe }}</div>
              <div class="stat-rank">{{ stat.rank|safe }}</div>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="carousel">
          <div class="carousel-title">Did you know?</div>
          <div class="carousel-slider">
            {% for fact in profile.splash.facts %}
              <p class="carousel-text{% if loop.index == 1%} active{% endif %}">{{ fact|safe }}</p>
            {% endfor %}
          </div>
          <div class="carousel-btns">
            <a href="#" class="carousel-btn">&#10229;</a>
            <span id="carousel-page">1</span><span>&#8201;/&#8201;</span><span>{{ profile.splash.facts|length }}</span>
            <a href="#" class="carousel-btn active">&#10230;</a>
          </div>
        </div>
      </div>
    </div>

    <div class="splash-icon-nav">
    {% for section in sections %}
      <a href="#{{ section.anchor }}"><img src="/static/img/icons/{{ section.anchor }}.svg" />
      <span>{{ section.title|safe }}</span></a>
    {% endfor %}
    </div>

      <!-- <div id="scroll-btn">
        <i class="fa fa-angle-down"></i>
      </div> -->

    </div>
  </div>

</article>
</div>

<div id="stats-bar">
  <div id="title-stats">
    {% for stat in profile.splash.stats %}
    <div class="title-stat">
      <div class="title-stat-text">{{ stat.title|safe }}</div>
      <div class="title-stat-value">{{ stat.value|safe }}</div>
    </div>
    {% endfor %}
  </div>
</div>

<div id="profile-nav">
  <ul>
  {% for section in sections %}
    <a href="#{{ section.anchor }}"><li data-anchor="{{ section.anchor }}"><img src="/static/img/icons/{{ section.anchor }}.svg" /> {{ section.title|safe }}</li></a>
  {% endfor %}
  </ul>
</div>

{% for section in sections %}
<header class="{{ section.anchor }}">
  <h2><a name="{{ section.anchor }}">{{ section.title|safe }}</a></h2>
  {% for desc in section.description %}
  <p>{{ desc|safe }}</p>
  {% endfor %}
</header>

<div class="section-sidenav" data-anchor="{{ section.anchor }}">
{% for topic in section.topics %}
  {% if topic.category %}
  <a class="section-sidenav-button" href="#{{ topic.category|safe|lower|replace(" ", "_") }}" data-anchor="{{ topic.category|safe|lower|replace(" ", "_") }}" data-tooltip="{{ topic.category|safe }}" data-tooltip-anchor="center right"></a>
  {% endif %}
{% endfor %}
</div>

<section class="{{ section.anchor }}">
  {% for topic in section.topics %}
  {% if topic.category %}
  <h1 class="category"><a name="{{ topic.category|safe|lower|replace(" ", "_") }}">{{ topic.category|safe }}</a></h1>
  {% endif %}
  {% if topic.items()|length > 1 or "category" not in topic %}
  <article class="topic{% if topic.class %} {{ topic.class }}{% endif %}">
    {% if topic.title %}
    <h2>{{ topic.title|safe }}</h2>
    {% endif %}
    {% if topic.subtitle %}
    <sub>{{ topic.subtitle|safe }}</sub>
    {% endif %}
    {% set aside = topic.stat or topic.description %}
    <div class="content{% if not aside %} full-width{% endif %}">
      {% if aside %}
      <aside>
        {% if topic.select %}
        <select id="topic-select-{{ loop.index0 }}" data-param="{{ topic.select.param }}" data-method="{{ topic.select.method }}" data-default="{{ topic.select.default }}">
          {% for option in topic.select.data %}
          <option value="{{ option.id }}"{% if topic.select.default == option.id %} selected{% endif %}>{{ option.name }}</option>
          {% endfor %}
        </select>
        {% endif %}
        {% if topic.stat %}
        <div class="topic-stats{% if topic.stat_stack %} stacked{% endif %}">
          {% for stat in topic.stat %}
            <div class="stat">
              <div class="stat-text">{{ stat.title|safe }}</div>
              <div class="stat-value">{{ stat.value|safe }}</div>
            </div>
          {% endfor %}
        </div>
        {% endif %}
        {% if topic.description %}
        {% for desc in topic.description %}
        <p>{{ desc|safe }}</p>
        {% endfor %}
        {% endif %}
        {% if topic.miniviz %}
        <div class="viz mini"{% if topic.miniviz.config.height %} style="max-height:{{ topic.miniviz.config.height }}px; height:{{ topic.miniviz.config.height }}px;"{% endif %}></div>
        <script>builds.push({{ topic.miniviz.serialize()|safe }});</script>
        {% endif %}
        {% if topic.source != False %}
        <sub>Data Source: <span class="source"></span></sub>
        {% endif %}
      </aside>
      {% endif %}
      {% for viz in topic.viz %}
      <div class="viz"{% if viz.config.height %} style="max-height:{{ viz.config.height }}px; height:{{ viz.config.height }}px;"{% endif %}></div>
      <script>builds.push({{ viz.serialize()|safe }});</script>
      {% endfor %}
      {% if topic.source != False and not aside and topic.viz %}
      <sub>Data Source: <span class="source"></span></sub>
      {% endif %}
    </div>
  </article>
  {% endif %}
  {% endfor %}
</section>

{% endfor %}

<div class="profile-end">
  <a href="/"><img src="/static/img/home/logo_2.png" alt="DataUSA" style="width:80px" /></a>
  <a href="#" class="to-top-btn">Go back top &uarr;</a>
</div>

{% endblock %}

{% block js %}

<script>

  var maxCarousel = d3.selectAll(".carousel-text").size() - 1, currentPage = 0;
  d3.selectAll(".carousel-btn").on("click", function(d, i){
    if (i && currentPage < maxCarousel) currentPage++;
    else if (i === 0 && currentPage > 0) currentPage--;

    d3.select("#carousel-page").text(currentPage + 1);

    d3.selectAll(".carousel-btn").classed("active", function(dd, ii){
      return !ii && currentPage || ii && currentPage < maxCarousel;
    });
    d3.selectAll(".carousel-text").classed("active", function(dd, ii){
      return ii === currentPage;
    });
  });

  var titleNavHeight = d3.select("#title-bar").node().offsetHeight + d3.select("#splash").node().offsetHeight/5;
  var profNavHeight = d3.select("#title-bar").node().offsetHeight + d3.select("#profile-nav").node().offsetHeight;
  var attr_type = "{{ profile.attr_type }}";

  function navScroll(){

    var y = window.scrollY,
        showTitleNav = y > titleNavHeight,
        showProfNav = y > window.innerHeight - profNavHeight;

    d3.select("#title-bar").classed("visible", showTitleNav);
    d3.select("#home-btn").classed("hidden", showTitleNav);
    d3.select("#profile-nav").classed("visible", showProfNav);

    var active_section;
    d3.selectAll("header a[name]")
      .each(function(){
        var top = this.parentNode.parentNode.offsetTop;
        if (top - titleNavHeight - 10 < y) active_section = this.name;
      })
    d3.selectAll("#profile-nav li, .section-sidenav")
      .classed("active", function(){
        return this.getAttribute("data-anchor") === active_section;
      });

    var active_sub;
    d3.selectAll(".category a[name]")
      .each(function(){
        var top = this.parentNode.offsetTop;
        if (top - titleNavHeight - 10 < y) {
          active_sub = this.name;
        }
      });
    d3.selectAll(".section-sidenav-button")
      .classed("active", function(){
        return this.getAttribute("data-anchor") === active_sub;
      });

  }

  navScroll();
  scrollFunctions.push(navScroll);

  builds.forEach(function(build, i){
    build.container = d3.select(d3.selectAll(".viz")[0][i]);
    build.loaded = false;
    build.timer = false;
    build.index = i;
    build.colors = vizStyles[attr_type];

    var select = d3.select(build.container.node().parentNode).select("select");
    if (select.size()) {

      d3plus.form()
        .search(false)
        .ui({
          "margin": 0
        })
        .focus({"callback": function(id){

          var param = this.getAttribute("data-param"),
              method = this.getAttribute("data-method"),
              prev = this.getAttribute("data-default");

          if (id !== prev) {

            d3.select(this).attr("data-default", id);

            d3.select(this.parentNode).selectAll(".select-text")
             .html(d3.select(this).select("option[value='"+ id +"']").text());

            d3.select(this.parentNode).selectAll(".stat-value span[data-url]")
             .each(function(){

               d3.select(this.parentNode).classed("loading", true);
               var url = this.getAttribute("data-url");
               if (param.length) {
                 url = url.replace(param + "=" + prev, param + "=" + id);
               }
               else {
                 url = url.replace("order=" + prev, "order=" + id);
                 url = url.replace("required=" + prev, "required=" + id);
               }
               d3.select(this).attr("data-url", url);

               load(url, function(data){
                 d3.select(this.parentNode).classed("loading", false)
                 d3.select(this).html(data.value);
               }.bind(this));

             });

            if (param.length) {
             build.data.forEach(function(b){
               b.url = b.url.replace(param + "=" + prev, param + "=" + id);
             });
             viz.loadData(build, "redraw");
            }
            else if (method.length) {
             build.viz[method](id).draw();
            }

          }

        }.bind(select.node())})
        .data(select)
        .width(select.node().parentNode.offsetWidth)
        .type("drop")
        .draw();

      // build.select = select.on("change", function(){
      //
      //   var param = this.getAttribute("data-param"),
      //       method = this.getAttribute("data-method"),
      //       id = this.value,
      //       prev = this.getAttribute("data-default");
      //
      //   d3.select(this).attr("data-default", id);
      //
      //   d3.select(this.parentNode).selectAll(".select-text")
      //     .html(this.options[this.selectedIndex].text);
      //
      //   d3.select(this.parentNode).selectAll(".stat-value span[data-url]")
      //     .each(function(){
      //
      //       d3.select(this.parentNode).classed("loading", true);
      //       var url = this.getAttribute("data-url");
      //       if (param.length) {
      //         url = url.replace(param + "=" + prev, param + "=" + id);
      //       }
      //       else {
      //         url = url.replace("order=" + prev, "order=" + id);
      //         url = url.replace("required=" + prev, "required=" + id);
      //       }
      //       d3.select(this).attr("data-url", url);
      //
      //       load(url, function(data){
      //         d3.select(this.parentNode).classed("loading", false)
      //         d3.select(this).html(data.value);
      //       }.bind(this));
      //
      //     });
      //
      //   if (param.length) {
      //     build.data.forEach(function(b){
      //       b.url = b.url.replace(param + "=" + prev, param + "=" + id);
      //     });
      //     viz.loadData(build, "redraw");
      //   }
      //   else if (method.length) {
      //     build.viz[method](id).draw();
      //   }
      //
      // });
    }

  });

  function resizeApps() {

    // var h = window.innerWidth < 768 ? window.innerHeight : window.innerHeight * 0.7;
    builds.forEach(function(b, i){
      // var w = d3.select(b.container.node().parentNode).node().offsetWidth;
      // var height = b.data && b.data.viz.slug === "network" ? window.innerWidth > 768 ? w * 0.7 : w : h * 0.9;
      // b.container.style("height", height + "px");
      b.top = b.container.node().offsetTop;
      b.height = b.container.node().offsetHeight;
      // if (w !== b.width || h !== b.height) {
      //   // if (b.viz) {
      //   //   if (b.loaded) b.viz.width(w).height(height).draw();
      //   // }
      //   // else {
      //   //   b.container.style("width", w + "px");
      //   // }
      //   b.width = w;
      //   b.height = height;
      // }
    })
  }
  resizeApps();
  resizeFunctions.push(resizeApps);

  var scrollBuffer = -200, n = [32], app;
  function buildInView(b) {
    var top = window.scrollY, height = window.innerHeight;
    return top+height > b.top+scrollBuffer && top+scrollBuffer < b.top+b.height;
  }

  function buildScroll(ms) {
    if (ms === undefined) ms = 0;
    for (var i = 0; i < builds.length; i++) {
      var b = builds[i];
      if (!b.timer && !b.loaded) {
        if (buildInView(b)) {
          b.timer = setTimeout(function(build){
            clearTimeout(build.timer);
            build.timer = false;
            if (buildInView(build)) {
            // if (buildInView(build) && n.indexOf(build.index) >= 0) {
              app = viz(build);
              build.loaded = true;
            }
          }, ms, b);
        }
      }
    }
  }

  buildScroll();
  scrollFunctions.push(buildScroll);

</script>

{% endblock %}
