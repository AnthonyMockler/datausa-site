{% extends "templates/nav.html" %}

{% block title %}{{ profile.splash.title }}{% endblock %}

{% block subtitle %}
<div id="title-bar">
  <span><a href="/"><img src="/static/img/home/logo_4.png" alt="DataUSA" /></a> | {{ profile.splash.title }}
  <a href="#" class="expand-stats-btn close"></a></span>
</div>
{% endblock %}

{% block body %}

<a name="top"></a>
<div class="bound">
  <div id="show-bg">
    <div><i class="fa fa-camera"></i></div>
  </div>

<article id="splash">

  {% set sections = profile.sections() %}
  {% set image = profile.image() %}

  <div id="splash-image"{% if image %} style="background-image: url('{{ image.url }}');"{% endif %}></div>

  <div class="content">

    <div class="splash-titles">

      {% if profile.splash.group %}
      <div class="splash-title-group">{{ profile.splash.group }} Profile</div>
      {% endif %}

      <h1>{{ profile.splash.title }}</h1>

      <div class="splash-breadcrumb">
        {% set parents = profile.parents() %}
        {% if parents|length %}
          <sub>
            {% for p in parents %}
              <a href="{{ url_for('profile.profile', attr_type=profile.attr_type, attr_id=p['id']) }}">{{ p["name"] }}</a>
            {% endfor %}
          </sub>
        {% endif %}
      </div>

    </div>

    <div class="splash-desc">
      {% for desc in profile.splash.description %}
      <p class="desc">{{ desc|safe }}</p>
      {% endfor %}
    </div>

    <div class="splash-context">

      {% if profile.splash.viz %}
      <div class="context-l">
        <div class="viz thumbprint">
          <div class="d3plus"></div>
        </div>
        <script>builds.push({{ profile.splash.viz.serialize()|safe }});</script>
      </div>
      {% endif %}

      <div class="context-r">
        <div id="splash-stats">
          {% for stat in profile.splash.stats %}
          <div class="stat">
            <div class="stat-text">{{ stat.title|safe }}</div>
            <div class="stat-group">
              <div class="stat-value">{{ stat.value|safe }}</div>
              <div class="stat-rank">{{ stat.rank|safe }}</div>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="carousel">
          <div class="carousel-title">Did you know?</div>
          <div class="carousel-slider">
            {% for fact in profile.splash.facts %}
              <p class="carousel-text{% if loop.index == 1%} active{% endif %}">{{ fact|safe }}</p>
            {% endfor %}
          </div>
          <div class="carousel-btns">
            <div class="carousel-btn">&#10229;</div>
            <span id="carousel-page">1</span><span>&#8201;/&#8201;</span><span>{{ profile.splash.facts|length }}</span>
            <div class="carousel-btn active">&#10230;</div>
          </div>
        </div>
      </div>
    </div>

    <div class="splash-icon-nav">
      {% for section in sections %}
      <a href="#{{ section.anchor }}" data-ga="splash {{ section.title|safe|lower }}" data-ga-cat="navigation" data-ga-label="User click">
        <img src="/static/img/icons/{{ section.anchor }}.svg" />
        <span>{{ section.title|safe }}</span>
      </a>
      {% endfor %}
    </div>

  </div>

  <div id="scroll-btn">
    <div class="mouse">
      <span class="ball"></span>
    </div>
    <div class="mouse-text">Scroll to Explore</div>
  </div>

</article>
</div>

<div id="nav-bar-scroll">
  <div id="stats-bar">
    <div id="title-stats">
      {% for stat in profile.splash.stats %}
      <div class="title-stat">
        <div class="title-stat-text">{{ stat.title|safe }}</div>
        <div class="title-stat-value">{{ stat.value|safe }}</div>
      </div>
      {% endfor %}
    </div>
  </div>

  <div id="profile-nav">
    <ul>
    {% for section in sections %}
      <a href="#{{ section.anchor }}"><li data-anchor="{{ section.anchor }}"><img src="/static/img/icons/{{ section.anchor }}.svg" /> {{ section.title|safe }}</li></a>
    {% endfor %}
    </ul>
    <a href="#top" id="back-to-top" data-tooltip="Back to Top" data-tooltip-anchor="center left" data-tooltip-offset="5"><i class="fa fa-long-arrow-up"></i></a>
  </div>
</div>

<div id="section-sidenav">
{% for section in sections %}
  <div class="section-sidenav-group">
  {% set categories = {"count": 0} %}
  {% for topic in section.topics %}
    {% if topic.category %}
    {% if categories.update({"count": categories.count + 1}) %}{% endif %}
    {% set anchor = topic.category|safe|lower|replace(" ", "_") %}
    <a class="section-sidenav-button" href="#{{ anchor }}" data-anchor="{{ anchor }}" data-tooltip="{{ topic.category|safe }}" data-tooltip-anchor="center right" data-ga="side nav circles" data-ga-cat="navigation" data-ga-label="User click"></a>
    {% endif %}
  {% endfor %}
  {% if categories.count == 0 %}
  <a class="section-sidenav-button" href="#{{ section.anchor }}" data-anchor="{{ section.anchor }}" data-tooltip="{{ section.title|safe }}" data-tooltip-anchor="center right" data-ga="side nav circles" data-ga-cat="navigation" data-ga-label="User click"></a>
  {% endif %}
  </div>
{% endfor %}
</div>

{% for section in sections %}
<header class="{{ section.anchor }}">
  <h2><a name="{{ section.anchor }}">{{ section.title|safe }}</a></h2>
  {% for desc in section.description %}
  <p>{{ desc|safe }}</p>
  {% endfor %}
</header>

<section class="{{ section.anchor }}">
  {% include "templates/includes/topic.html" %}
</section>

{% endfor %}

<div class="profile-end">

  <header>
    <h2>Keep Exploring</h2>
    <p>Profiles we think you'd be interested in visiting next...</p>
  </header>

  <!-- follow up profile links -->
  <div class="follow-up">

    {% set parents = profile.parents() %}
    {% if parents|length %}
    <ul>
      {% for p in parents %}
      <li style="background: url('/profile/{{ profile.attr_type }}/{{ p.id }}/img/');">
        <a href="{{ url_for('profile.profile', attr_type=profile.attr_type, attr_id=p['id']) }}">
          <div class="explore-title">{{ p["name"] }}</div>
        </a>
      </li>
      {% endfor %}
    </ul>
    {% endif %}
  </div>
  <!-- end .follow-up -->

  <!-- ending footer  -->
  <!-- <a href="/" data-ga="profile end home" data-ga-cat="profile" data-ga-label="home"><img src="/static/img/home/logo_4.png" alt="DataUSA" style="width:104px" /></a>
  <a href="#" class="to-top-btn" data-ga="back to top" data-ga-cat="profile" data-ga-label="top">Go back top &uarr;</a> -->
</div>

{% endblock %}

{% block js %}

<script>

  var fontScale = d3.scale.linear()
    .domain([60, 20])
    .range([35, 55]);

  var title = d3.select(".splash-titles h1");
  title.style("font-size", fontScale(title.text().length) + "px");

  var scrollTimeout = setTimeout(function(){
    d3.select("#scroll-btn").classed("visible", true);
  }, 5000);

  var maxCarousel = d3.selectAll(".carousel-text").size() - 1, currentPage = 0;
  d3.selectAll(".carousel-btn").on("click", function(d, i){
    if (i && currentPage < maxCarousel) currentPage++;
    else if (i === 0 && currentPage > 0) currentPage--;

    d3.select("#carousel-page").text(currentPage + 1);

    d3.selectAll(".carousel-btn").classed("active", function(dd, ii){
      return !ii && currentPage || ii && currentPage < maxCarousel;
    });
    d3.selectAll(".carousel-text").classed("active", function(dd, ii){
      return ii === currentPage;
    });
  });

  d3.select(".expand-stats-btn").on("click", function(){
    d3.event.preventDefault();
    d3.select(this).classed("close", !d3.select(this).classed("close"));
    d3.select("#nav-bar-scroll").classed("stat-hidden", !d3.select("#nav-bar-scroll").classed("stat-hidden"));
  });

  var splashHeight = d3.select("#splash").node().offsetHeight,
      titleNavHeight = d3.select("#title-bar").node().offsetHeight + splashHeight/5,
      statNavHeight = titleNavHeight + splashHeight/3,
      profNavHeight = d3.select("#title-bar").node().offsetHeight + d3.select("#stats-bar").node().offsetHeight,
      attr_type = "{{ profile.attr_type }}";

  // var firstScroll = true;
  function navScroll(){

    // if (!firstScroll) {
    //   clearTimeout(scrollTimeout);
    //   d3.select("#scroll-btn").classed("visible", false);
    // }
    // firstScroll = false;

    var y = window.scrollY,
        showTitleNav = y > titleNavHeight,
        showStatNav = y > statNavHeight,
        showProfNav = y > window.innerHeight - profNavHeight - 35;

    d3.select("#title-bar").classed("visible", showTitleNav);
    d3.select("#home-btn").classed("hidden", showTitleNav);

    d3.select("#stats-bar").classed("visible", showStatNav);
    d3.select(".expand-stats-btn").classed("show", showStatNav);
    d3.select("#profile-nav").classed("visible", showProfNav);
    d3.select("#section-sidenav").classed("visible", showProfNav);

    var active_section;
    d3.selectAll("header a[name]")
      .each(function(){
        var top = this.parentNode.parentNode.offsetTop;
        if (top - titleNavHeight - 10 < y) active_section = this.name;
      })
    d3.selectAll("#profile-nav li")
      .classed("active", function(){
        return this.getAttribute("data-anchor") === active_section;
      });

    var active_sub;
    var subs = d3.selectAll("section." + active_section + " .category a[name]");
    if (subs.size()) {
      subs.each(function(){
          var top = this.parentNode.offsetTop;
          if (top - titleNavHeight - 10 < y) {
            active_sub = this.name;
          }
        });
    }
    else {
      active_sub = active_section;
    }
    d3.selectAll(".section-sidenav-button")
      .classed("active", function(){
        return this.getAttribute("data-anchor") === active_sub;
      })

  }

  navScroll();
  scrollFunctions.push(navScroll);


  d3.select("#show-bg").on("click", function(){
    var show = d3.select("#splash-image").classed("color");
    d3.select("#splash-image").classed("color", !show);
    d3.select("#splash .content").classed("hide", !show);
  });

</script>

{% endblock %}
