{% extends "templates/nav.html" %}

{% block body %}

<script>var builds = [];</script>

<article id="splash">

  <div id="splash-image" style="background-image: url('{{ profile.image() }}');"></div>

  <div class="content">

    <div class="thumbprint"></div>

    <h1>{{ profile.splash.title }}</h1>
    {% set parents = profile.parents() %}
    {% if parents|length %}
      <sub>
        {% for p in parents %}
          <a href="{{ url_for('profile.profile', attr_type=profile.attr_type, attr_id=p['id']) }}">{{ p["name"] }}</a>
        {% endfor %}
      </sub>
    {% endif %}
    <p class="desc">{{ profile.splash.description }}</p>

    <div id="splash-stats">
      {% for stat in profile.splash.stats %}
      <div class="stat">
        <div class="stat-text">{{ stat.title }}</div>
        <div class="stat-value">{{ stat.value }}</div>
        <div class="stat-rank">Rank: {{ stat.rank }}</div>
      </div>
      {% endfor %}
    </div>

    <div class="carousel">
      <div class="carousel-title">Did you know?</div>
      <div class="carousel-slider">
        {% for fact in profile.splash.facts %}
          <p class="carousel-text{% if loop.index == 1%} active{% endif %}">{{ fact }}</p>
        {% endfor %}
      </div>
      <div class="carousel-btns">
        {% for fact in profile.splash.facts %}
          <div class="carousel-btn{% if loop.index == 1%} active{% endif %}" style="background-color:{{ profile.color() }}"></div>
        {% endfor %}
      </div>
    </div>

    <div id="scroll-btn">
      <i class="fa fa-angle-down"></i>
    </div>

  </div>

</article>

<div id="title-bar" style="background-color: {{ profile.color() }};">
  <h1>{{ profile.attr.name }}</h1>
</div>

{% set sections = profile.sections() %}

<div id="profile-nav">
  <ul>
  {% for section in sections %}
    <a href="#{{ section.title }}"><li>{{ section.title }}</li></a>
  {% endfor %}
  </ul>
</div>

{% for section in sections %}
<header>
  <h2><a name="{{ section.title }}">{{ section.title }}</a></h2>
  <p>{{ section.description }}</p>
</header>

{% for topic in section.topics %}
<article class="topic">
  <h2 style="color: {{ profile.color() }};">{{ topic.title }}</h2>
  {% if topic.subtitle %}
    <sub>{{ topic.subtitle }}</sub>
  {% endif %}
  <div class="content">
    <aside>
      {% if topic.stat %}
      <div class="topic-stats{% if topic.stat_stack %} stacked{% endif %}">
        {% for stat in topic.stat %}
          <div class="stat">
            <div class="stat-text">{{ stat.title }}</div>
            <div class="stat-value">{{ stat.value }}</div>
          </div>
        {% endfor %}
      </div>
      {% endif %}
      {% if topic.description %}
      <p>{{ topic.description }}</p>
      {% endif %}
      <sub>Data Source: <span class="source"></span></sub>
    </aside>
    <div class="viz"{% if topic.viz.height %} style="height:{{ topic.viz.height }}px;"{% endif %}></div>
  </div>
</article>
<script>builds.push({{ topic.viz.serialize()|safe }});</script>
{% endfor %}

{% endfor %}

{% endblock %}

{% block js %}

<script>

  var titleHeight = d3.select("#title-bar").node().offsetHeight + d3.select("#profile-nav").node().offsetHeight,
      color = "{{ profile.color() }}";

  scrollFunctions.push(function(y){

    var showNav = y > window.innerHeight - titleHeight - 10;
    d3.select("#title-bar").classed("visible", showNav);
    d3.select("#profile-nav").classed("visible", showNav);

    var active_section;
    d3.selectAll("a[name]")
      .each(function(){
        var top = this.parentNode.parentNode.offsetTop;
        if (top - titleHeight - 10 < y) active_section = this.name;
      })
    d3.selectAll("#profile-nav li")
      .style("color", function(){
        return this.innerHTML === active_section ? color : null;
      })
      .classed("active", function(){
        return this.innerHTML === active_section;
      });

  });

  builds.forEach(function(build, i){
    build.container = d3.select(d3.selectAll(".viz")[0][i]);
    build.loaded = false;
    build.timer = false;
    build.index = i;
  });

  function resizeApps() {

    // var h = window.innerWidth < 768 ? window.innerHeight : window.innerHeight * 0.7;
    builds.forEach(function(b, i){
      // var w = d3.select(b.container.node().parentNode).node().offsetWidth;
      // var height = b.data && b.data.viz.slug === "network" ? window.innerWidth > 768 ? w * 0.7 : w : h * 0.9;
      // b.container.style("height", height + "px");
      b.top = b.container.node().offsetTop;
      b.height = b.container.node().offsetHeight;
      // if (w !== b.width || h !== b.height) {
      //   // if (b.viz) {
      //   //   if (b.loaded) b.viz.width(w).height(height).draw();
      //   // }
      //   // else {
      //   //   b.container.style("width", w + "px");
      //   // }
      //   b.width = w;
      //   b.height = height;
      // }
    })
  }
  resizeApps();
  resizeFunctions.push(resizeApps);

  var scrollBuffer = -200, n = 9, app;
  function buildInView(b) {
    var top = window.scrollY, height = window.innerHeight;
    return top+height > b.top+scrollBuffer && top+scrollBuffer < b.top+b.height;
  }

  function buildScroll(ms) {
    if (ms === undefined) ms = 500;
    for (var i = 0; i < builds.length; i++) {
      var b = builds[i];
      if (!b.timer && !b.loaded) {
        if (buildInView(b)) {
          b.timer = setTimeout(function(build){
            clearTimeout(build.timer);
            build.timer = false;
            // if (buildInView(build)) {
            if (buildInView(build) && build.index === n) {
              app = viz(build);
              build.loaded = true;
            }
          }, ms, b);
        }
      }
    }
  }

  buildScroll(0);

  scrollFunctions.push(buildScroll);

</script>

{% endblock %}
