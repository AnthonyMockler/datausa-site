{% extends "templates/nav.html" %}

{% block body %}

<script>var builds = [];</script>

<article id="splash">

  {% set image = profile.image() %}
  <div id="splash-image"{% if image %} style="background-image: url('{{ image.url }}');"{% endif %}></div>

  <div class="content">

    <div class="thumbprint"></div>

    <h1>{{ profile.splash.title }}</h1>
    {% set parents = profile.parents() %}
    {% if parents|length %}
      <sub>
        {% for p in parents %}
          <a href="{{ url_for('profile.profile', attr_type=profile.attr_type, attr_id=p['id']) }}">{{ p["name"] }}</a>
        {% endfor %}
      </sub>
    {% endif %}
    {% for desc in profile.splash.description %}
    <p class="desc">{{ desc|safe }}</p>
    {% endfor %}

    <div id="splash-stats">
      {% for stat in profile.splash.stats %}
      <div class="stat">
        <div class="stat-text">{{ stat.title|safe }}</div>
        <div class="stat-value">{{ stat.value|safe }}</div>
        <div class="stat-rank">Rank: {{ stat.rank|safe }}</div>
      </div>
      {% endfor %}
    </div>

    <div class="carousel">
      <div class="carousel-title">Did you know?</div>
      <div class="carousel-slider">
        {% for fact in profile.splash.facts %}
          <p class="carousel-text{% if loop.index == 1%} active{% endif %}">{{ fact|safe }}</p>
        {% endfor %}
      </div>
      <div class="carousel-btns">
        {% for fact in profile.splash.facts %}
          <div class="carousel-btn{% if loop.index == 1%} active{% endif %}"></div>
        {% endfor %}
      </div>
    </div>

    <div id="scroll-btn">
      <i class="fa fa-angle-down"></i>
    </div>

  </div>

</article>

<div id="title-bar" style="background-color: {{ profile.color() }};">
  <h1>{{ profile.splash.title }}</h1>
</div>

{% set sections = profile.sections() %}

<div id="profile-nav">
  <ul>
  {% for section in sections %}
    <a href="#{{ section.anchor }}"><li data-anchor="{{ section.anchor }}">{{ section.title|safe }}</li></a>
  {% endfor %}
  </ul>
</div>

{% for section in sections %}
<header>
  <h2><a name="{{ section.anchor }}">{{ section.title|safe }}</a></h2>
  {% for desc in section.description %}
  <p>{{ desc|safe }}</p>
  {% endfor %}
</header>

<section>
  {% for topic in section.topics %}
  {% if topic.category %}
  <h1 class="category" style="color: {{ profile.color() }};">{{ topic.category|safe }}</h1>
  {% endif %}
  <article class="topic{% if topic.class %} {{ topic.class }}{% endif %}">
    {% if topic.title %}
    <h2 style="color: {{ profile.color() }};">{{ topic.title|safe }}</h2>
    {% endif %}
    {% if topic.subtitle %}
    <sub>{{ topic.subtitle|safe }}</sub>
    {% endif %}
    {% set aside = topic.stat or topic.description %}
    <div class="content{% if not aside %} full-width{% endif %}">
      {% if aside %}
      <aside>
        {% if topic.select %}
        <select id="topic-select-{{ loop.index0 }}" data-param="{{ topic.select.param }}" data-method="{{ topic.select.method }}" data-default="{{ topic.select.default }}">
          {% for option in topic.select.data %}
          <option value="{{ option.id }}"{% if topic.select.default == option.id %} selected{% endif %}>{{ option.name }}</option>
          {% endfor %}
        </select>
        {% endif %}
        {% if topic.stat %}
        <div class="topic-stats{% if topic.stat_stack %} stacked{% endif %}">
          {% for stat in topic.stat %}
            <div class="stat">
              <div class="stat-text">{{ stat.title|safe }}</div>
              <div class="stat-value">{{ stat.value|safe }}</div>
            </div>
          {% endfor %}
        </div>
        {% endif %}
        {% if topic.description %}
        {% for desc in topic.description %}
        <p>{{ desc|safe }}</p>
        {% endfor %}
        {% endif %}
        {% if topic.miniviz %}
        <div class="viz mini"{% if topic.miniviz.config.height %} style="max-height:{{ topic.miniviz.config.height }}px; height:{{ topic.miniviz.config.height }}px;"{% endif %}></div>
        <script>builds.push({{ topic.miniviz.serialize()|safe }});</script>
        {% endif %}
        {% if topic.source != False %}
        <sub>Data Source: <span class="source"></span></sub>
        {% endif %}
      </aside>
      {% endif %}
      {% for viz in topic.viz %}
      <div class="viz"{% if viz.config.height %} style="max-height:{{ viz.config.height }}px; height:{{ viz.config.height }}px;"{% endif %}></div>
      <script>builds.push({{ viz.serialize()|safe }});</script>
      {% endfor %}
      {% if topic.source != False and not aside %}
      <sub>Data Source: <span class="source"></span></sub>
      {% endif %}
    </div>
  </article>
  {% endfor %}
</section>

{% endfor %}

{% endblock %}

{% block js %}

<script>

  d3.selectAll(".carousel-btn").on("click", function(d, i){
    d3.selectAll(".carousel-btn").classed("active", function(dd, ii){
      return ii === i;
    });
    d3.selectAll(".carousel-text").classed("active", function(dd, ii){
      return ii === i;
    });
  });

  var titleHeight = d3.select("#title-bar").node().offsetHeight + d3.select("#profile-nav").node().offsetHeight,
      color = "{{ profile.color() }}";

  function navScroll(){

    var y = window.scrollY,
        showNav = y > window.innerHeight - titleHeight - 10;
    d3.select("#title-bar").classed("visible", showNav);
    d3.select("#profile-nav").classed("visible", showNav);

    var active_section;
    d3.selectAll("a[name]")
      .each(function(){
        var top = this.parentNode.parentNode.offsetTop;
        if (top - titleHeight - 10 < y) active_section = this.name;
      })
    d3.selectAll("#profile-nav li")
      .style("color", function(){
        return this.getAttribute("data-anchor") === active_section ? color : null;
      })
      .classed("active", function(){
        return this.getAttribute("data-anchor") === active_section;
      });

  }

  navScroll();
  scrollFunctions.push(navScroll);

  builds.forEach(function(build, i){
    build.container = d3.select(d3.selectAll(".viz")[0][i]);
    build.loaded = false;
    build.timer = false;
    build.index = i;

    var select = d3.select(build.container.node().parentNode).select("select");
    if (select.size()) {
      build.select = select.on("change", function(){

        var param = this.getAttribute("data-param"),
            method = this.getAttribute("data-method"),
            id = this.value,
            prev = this.getAttribute("data-default");

        d3.select(this).attr("data-default", id);

        d3.select(this.parentNode).selectAll(".select-text")
          .html(this.options[this.selectedIndex].text);

        d3.select(this.parentNode).selectAll(".stat-value span[data-url]")
          .each(function(){

            d3.select(this.parentNode).classed("loading", true);
            var url = this.getAttribute("data-url");
            if (param.length) {
              url = url.replace(param + "=" + prev, param + "=" + id);
            }
            else {
              url = url.replace("order=" + prev, "order=" + id);
              url = url.replace("required=" + prev, "required=" + id);
            }
            d3.select(this).attr("data-url", url);

            load(url, function(data){
              d3.select(this.parentNode).classed("loading", false)
              d3.select(this).html(data.value);
            }.bind(this));

          });

        if (param.length) {
          build.data.forEach(function(b){
            b.url = b.url.replace(param + "=" + prev, param + "=" + id);
          });
          viz.loadData(build, "redraw");
        }
        else if (method.length) {
          build.viz[method](id).draw();
        }

      });
    }

  });

  function resizeApps() {

    // var h = window.innerWidth < 768 ? window.innerHeight : window.innerHeight * 0.7;
    builds.forEach(function(b, i){
      // var w = d3.select(b.container.node().parentNode).node().offsetWidth;
      // var height = b.data && b.data.viz.slug === "network" ? window.innerWidth > 768 ? w * 0.7 : w : h * 0.9;
      // b.container.style("height", height + "px");
      b.top = b.container.node().offsetTop;
      b.height = b.container.node().offsetHeight;
      // if (w !== b.width || h !== b.height) {
      //   // if (b.viz) {
      //   //   if (b.loaded) b.viz.width(w).height(height).draw();
      //   // }
      //   // else {
      //   //   b.container.style("width", w + "px");
      //   // }
      //   b.width = w;
      //   b.height = height;
      // }
    })
  }
  resizeApps();
  resizeFunctions.push(resizeApps);

  var scrollBuffer = -200, n = [32], app;
  function buildInView(b) {
    var top = window.scrollY, height = window.innerHeight;
    return top+height > b.top+scrollBuffer && top+scrollBuffer < b.top+b.height;
  }

  function buildScroll(ms) {
    if (ms === undefined) ms = 0;
    for (var i = 0; i < builds.length; i++) {
      var b = builds[i];
      if (!b.timer && !b.loaded) {
        if (buildInView(b)) {
          b.timer = setTimeout(function(build){
            clearTimeout(build.timer);
            build.timer = false;
            if (buildInView(build)) {
            // if (buildInView(build) && n.indexOf(build.index) >= 0) {
              app = viz(build);
              build.loaded = true;
            }
          }, ms, b);
        }
      }
    }
  }

  buildScroll();
  scrollFunctions.push(buildScroll);

</script>

{% endblock %}
