{% extends "templates/nav.html" %}

{% block body %}

<div id="search-advanced">
  <div class="search-nav">
    <input class="search-input" data-search="advanced" type="text" placeholder="Search DataUSA&hellip;" autofocus />
    
    <div class="search-filters" tabindex="1">
      <a class="search-filters-toggle">
        <span class="search-filters-toggle-label">All</span>
        <span class="search-filters-toggle-icon"></span>
      </a>
      <div class="search-filters-options" style="top: 65px;">
        <ul class="search-filters-options-inner">
          <li><a href="#" class="search-filter active" data-filter="">All</a></li>
          <li><a href="#" class="search-filter" data-filter="geo">Locations</a></li>
          <li><a href="#" class="search-filter" data-filter="naics">Industries</a></li>
          <li><a href="#" class="search-filter" data-filter="soc">Occupations</a></li>
          <li><a href="#" class="search-filter" data-filter="cip">College Majors</a></li>
        </ul>
      </div>
    </div>
  </div>
  
  <div class="search-nestings">
    <div class="search-nestings-geo">
      <a href="#" data-depth="0">States</a>
      <a href="#" data-depth="1">Counties</a>
      <a href="#" data-depth="2">MSAs</a>
      <a href="#" data-depth="3">Places</a>
      <a href="#" data-depth="5">PUMAs</a>
    </div>
    <div class="search-nestings-naics">
      <a href="#" data-depth="0">Top Level</a>
      <a href="#" data-depth="1">2 digit</a>
      <a href="#" data-depth="2">3 digit</a>
    </div>
    <div class="search-nestings-soc">
      <a href="#" data-depth="0">Top Level</a>
      <a href="#" data-depth="1">2 digit</a>
      <a href="#" data-depth="2">3 digit</a>
      <a href="#" data-depth="3">4 digit</a>
    </div>
    <div class="search-nestings-cip">
      <a href="#" data-depth="0">2 digit</a>
      <a href="#" data-depth="1">4 digit</a>
      <a href="#" data-depth="2">6 digit</a>
    </div>
  </div>
  
  <div class="search-results-container">
    <div class="search-results"></div>
    <div class="search-details">
      <h2 class="details-title">&mdash;</h2>
      <div class="details-sumlevels"></div>
      <div class="details-sumlevels-results"></div>
      <div class="details-anchors"></div>
      <a href="#" class="details-profile">Go to Profile &gt;</a>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<script>
  search.anchors = {{anchors|safe}};

  /*
   * Constrain search to specific types of attrs
   */
  d3.selectAll(".search-filter").on("click", function(){
    
    // set constrained search mode
    search.type = d3.select(this).attr("data-filter");
    
    // close inner dropdown and set title
    d3.select(".search-filters-options").style("opacity", 0)
    d3.select(".search-filters-toggle-label").text(d3.select(this).text())
    
    // set active link for profile type
    d3.selectAll(".search-filters-options-inner a").classed("active", false)
    d3.select(this).classed("active", true)

    // show appropriate nesting levels
    d3.selectAll(".search-nestings > div").style("display", "none")
    d3.select(".search-nestings-"+search.type).style("display", "block")
    
    // activate first nesting level if no levels been selected previously
    if(search.type){
      var active_nesting = d3.selectAll(".search-nestings-"+search.type+" a").filter(function(){
        return d3.select(this).classed("active")
      })
      active_nesting = active_nesting.size() ? active_nesting : d3.select(".search-nestings-"+search.type+" a");
      active_nesting.on("click")(active_nesting.node())
    }
    else {
      search.reload();
    }
    
    // prevent default anchor link behavior
    d3.event.preventDefault();
  })
  
  /*
   * Constrain search to specific nesting/sumlevel of attrs
   */
  d3.selectAll(".search-nestings a").on("click", function(active_el){
    var _this = active_el || this;
    
    // set constrained search mode with appropriate sumlevel
    search.term = "";
    search.current_depth[search.type] = d3.select(_this).attr("data-depth");
    search.reload();
    
    // set active link for profile type
    d3.select(_this.parentNode).selectAll("a").classed("active", false)
    d3.select(_this).classed("active", true)
    
    // prevent default anchor link behavior
    d3.event.preventDefault();
  })
  
  d3.select(".search-filters-toggle").on("click", function(){
    var current_opacity = parseInt(d3.select(".search-filters-options").style("opacity"));
    d3.select(".search-filters-options").style("opacity", (current_opacity+1)%2)
    d3.event.stopPropagation();
  })

  var term = location.search ? location.search.split("=")[1] : "";
  search.term = term.replace(/%20/g, " ");
  search.advanced = true;
  search.container = d3.select("#search-advanced");

  var input = d3.select(".search-input").attr("value", search.term);
  if (input.node().setSelectionRange !== undefined) {
    input.node().setSelectionRange(search.term.length, search.term.length);
  }

  search.reload();
  
  d3.select(document).on("click", function(){
    d3.select(".search-filters-options").style("opacity", 0)
  })

</script>
{% endblock %}
